app-id: com.github.happycube.LdDecode
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: ld-decode
finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --filesystem=home
  - --share=network

modules:
  - name: python3-deps
    buildsystem: simple
    build-commands:
      - pip3 install --verbose --exists-action=i --ignore-installed --no-index --find-links="file://${PWD}/wheels"
        --prefix=${FLATPAK_DEST} -r requirements.txt
    sources:
      - type: dir
        path: wheels
        dest: wheels
      - type: file
        path: requirements.txt

  - name: ld-decode
    buildsystem: simple
    build-commands:
      - |
        # Extract version from git describe or use default
        VERSION=$(git describe --tags --exact-match 2>/dev/null || echo "7.0.0")
        VERSION="${VERSION#v}"
        # Update pyproject.toml with the version
        sed -i "s/version = \"[^\"]*\"/version = \"$VERSION\"/" pyproject.toml
        
        # Generate version file with git info
        BRANCH="release"
        COMMIT="unknown"
        DIRTY=""
        
        if git describe --tags --exact-match > /dev/null 2>&1; then
          COMMIT=$(git describe --tags --exact-match | sed 's/^v//')
          BRANCH="release"
        elif git describe --tags --always > /dev/null 2>&1; then
          COMMIT=$(git describe --tags --always | sed 's/^v//')
        fi
        
        if [ -z "$BRANCH" ] || [ "$BRANCH" = "HEAD" ]; then
          BRANCH=$(git rev-parse --abbrev-ref HEAD)
          if [ "$BRANCH" = "HEAD" ]; then
            BRANCH="release"
          fi
        fi
        
        if [ -n "$(git status --porcelain)" ]; then
          DIRTY=":dirty"
        fi
        
        VERSION_STRING="${BRANCH}:${COMMIT}${DIRTY}"
        echo "$VERSION_STRING" > lddecode/version
        
        pip3 install --verbose --exists-action=i --ignore-installed --no-index --find-links="file://${PWD}/wheels" --prefix=${FLATPAK_DEST} .
    sources:
      - type: dir
        path: ../..
      - type: dir
        path: wheels
        dest: wheels

  - name: metainfo
    buildsystem: simple
    build-commands:
      - install -Dm644 com.github.happycube.LdDecode.metainfo.xml -t /app/share/metainfo/
      - install -Dm644 com.github.happycube.LdDecode.desktop -t /app/share/applications/
    sources:
      - type: file
        path: com.github.happycube.LdDecode.metainfo.xml
      - type: file
        path: com.github.happycube.LdDecode.desktop
