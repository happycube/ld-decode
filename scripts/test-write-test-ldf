#!/usr/bin/env bash
#
# test-write-test-ldf - test the --write-test-ldf option
# Copyright (C) 2025
#
# This file is part of ld-decode.
#
# test-write-test-ldf is free software: you can redistribute it and/or
# modify it under the terms of the GNU General Public License as
# published by the Free Software Foundation, either version 3 of the
# License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

set -e

# Default values
BUILD_DIR="."
SOURCE_DIR="."
TESTDATA_DIR="testdata"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --build)
            BUILD_DIR="$2"
            shift 2
            ;;
        --source)
            SOURCE_DIR="$2"
            shift 2
            ;;
        --testdata)
            TESTDATA_DIR="$2"
            shift 2
            ;;
        --input)
            INPUT_FILE="$2"
            shift 2
            ;;
        --system)
            SYSTEM="$2"
            shift 2
            ;;
        --start)
            START="$2"
            shift 2
            ;;
        --length)
            LENGTH="$2"
            shift 2
            ;;
        *)
            echo "Unknown option: $1"
            exit 1
            ;;
    esac
done

# Validate required parameters
if [[ -z "$INPUT_FILE" ]]; then
    echo "Error: --input is required"
    exit 1
fi

if [[ -z "$SYSTEM" ]]; then
    echo "Error: --system is required (ntsc or pal)"
    exit 1
fi

# Set system flag
if [[ "$SYSTEM" == "ntsc" ]]; then
    SYSTEM_FLAG="--NTSC"
elif [[ "$SYSTEM" == "pal" ]]; then
    SYSTEM_FLAG="--PAL"
else
    echo "Error: --system must be 'ntsc' or 'pal'"
    exit 1
fi

# Default values
START=${START:-0}
LENGTH=${LENGTH:-5}

# Construct paths
LD_DECODE="$SOURCE_DIR/ld-decode"
INPUT_PATH="$TESTDATA_DIR/$INPUT_FILE"
TEMP_DIR=$(mktemp -d)

echo "Testing --write-test-ldf feature..."
echo "  Input: $INPUT_PATH"
echo "  System: $SYSTEM"
echo "  Start: $START"
echo "  Length: $LENGTH"
echo "  Temp dir: $TEMP_DIR"

# Set up PATH for helper programs
export PATH="$BUILD_DIR:$BUILD_DIR/tools/ld-ldf-reader:$SOURCE_DIR:$PATH"

# Test 1: Decode with position switches and extract test LDF
echo ""
echo "Test 1: Extracting test LDF..."
EXTRACTED_LDF="$TEMP_DIR/extracted.ldf"
FULL_OUTPUT="$TEMP_DIR/full"

$LD_DECODE $SYSTEM_FLAG --start $START --length $LENGTH \
    --write-test-ldf "$EXTRACTED_LDF" \
    "$INPUT_PATH" "$FULL_OUTPUT"

if [[ ! -f "$EXTRACTED_LDF" ]]; then
    echo "FAIL: Extracted LDF not created"
    exit 1
fi

# Verify it's an LDF file (FLAC in Ogg container)
FILE_TYPE=$(file "$EXTRACTED_LDF")
if [[ ! "$FILE_TYPE" =~ "Ogg data, FLAC" ]]; then
    echo "FAIL: Output is not an LDF file (FLAC in Ogg)"
    echo "Got: $FILE_TYPE"
    exit 1
fi

echo "PASS: Extracted LDF created and is correct format"

# Test 2: Decode the extracted LDF without position switches
echo ""
echo "Test 2: Decoding extracted LDF..."
REEXTRACT_OUTPUT="$TEMP_DIR/reextract"

$LD_DECODE $SYSTEM_FLAG "$EXTRACTED_LDF" "$REEXTRACT_OUTPUT"

if [[ ! -f "$REEXTRACT_OUTPUT.tbc" ]]; then
    echo "FAIL: Re-decoded TBC not created"
    exit 1
fi

echo "PASS: Extracted LDF decoded successfully"

# Test 3: Compare TBC files (first N fields should match)
echo ""
echo "Test 3: Comparing decoded output..."

# Get field size based on system
if [[ "$SYSTEM" == "ntsc" ]]; then
    FIELD_SIZE=$((910 * 263 * 2))
else
    FIELD_SIZE=$((1135 * 313 * 2))
fi

# Calculate number of fields to compare (original length in frames * 2)
FIELDS_TO_COMPARE=$((LENGTH * 2))
BYTES_TO_COMPARE=$((FIELDS_TO_COMPARE * FIELD_SIZE))

# Compare the first N fields byte-for-byte
if cmp -n $BYTES_TO_COMPARE "$FULL_OUTPUT.tbc" "$REEXTRACT_OUTPUT.tbc"; then
    echo "PASS: First $FIELDS_TO_COMPARE fields are byte-for-byte identical"
else
    echo "FAIL: TBC files differ"
    exit 1
fi

# Test 4: Verify safety check (prevent overwriting input)
echo ""
echo "Test 4: Testing safety check..."
if $LD_DECODE $SYSTEM_FLAG --length 1 --write-test-ldf "$INPUT_PATH" "$INPUT_PATH" "$TEMP_DIR/safety" 2>&1 | grep -q "cannot be the same as input"; then
    echo "PASS: Safety check prevents overwriting input file"
else
    echo "FAIL: Safety check did not prevent overwriting input file"
    exit 1
fi

# Cleanup
rm -rf "$TEMP_DIR"

echo ""
echo "All tests PASSED!"
exit 0
